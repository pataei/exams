\section{Annotations and Variational Sets}
\label{sec:vset}


%\point{annotating elements of database with feature expressions.}
We now introduce the first approach used to incorporate variation into a database.
To incorporate feature expressions into the database,
we \emph{annotate} database elements (including attributes, relations, and tuples) 
with feature expressions. An \emph{annotated element} \elem\ with feature expression \dimMeta\
is denoted by \annot \elem, 
that is, if \elem\ has type \typevar\ (i.e., $\elem \in \typevar$)
then $\annot \elem$ has the corresponding variational type 
$\vartype \typevar$ (i.e., $\annot \elem \in \vartype \typevar$).
%The feature expression \dimMeta\ represents
%the set of configurations where their variants contain element \elem\ because
%
The feature expression attached to an element is called its \emph{presence
condition} since it determines the condition (set of configurations) under
which the element is present in the database. 
This is done by the \emph{configuration} function $\xeSem [] . : \elemSet \totype \confSet \totype \maybe {\pelemSet}$ defined in \figref{vset}.
For example, assuming
$\features=\set{\A,\B}$, the annotated number $\annot [\A \vee \B] 2$ is present
in variants \setDef{\A} (i.e., $\xeSem [\setDef{\A}] {\annot [\A \vee \B] 2}$ = 2), 
\setDef{\B} (i.e., $\xeSem [\setDef{\A}] {\annot [\A \vee \B] 2}$ = 2), 
and \setDef{\A,\B} (i.e.,$\xeSem [\setDef{\A, \B}] {\annot [\A \vee \B] 2} = 2$) 
but not in variant
\setDef{} (i.e., $\xeSem [\setDef { }] {\annot [\A \vee \B] 2} = \bot$). 
%
The operation $\getPC{\annot{\elem}}=e$ returns the presence condition of an
annotated element.
% with a configuration
%that enables either $\A$ or $\B$ or both
%variants that disable both $\A$ and $\B$.
% Here, $\getPC {\annot [\A \vee \B] 2} = \A \vee \B$.

\input{formulas/vset}

%\point{vset.}
A \emph{variational set} (\emph{v-set}) $\vset = \setDef {\annot [\dimMeta_1] {\elem_1},\ldots, \annot [\dimMeta_n] {\elem_n}}$ 
is a set of annotated elements, 
that is,
$\vset \in \vsetSet$~\cite{EWC13fosd,Walk14onward,ATW17dbpl}.
We typically omit the presence condition \t\ in a variational set,
e.g., $\annot [\t] 4 = 4$.
% where the presence condition of elements is satisfiable~\cite{EWC13fosd,Walk14onward,vdb17ATW}. 
%
Conceptually, a variational set represents many different plain sets simultaneously.
These plain sets can be generated by \emph{configuring} a variational set with a configuration.
This is done by the \emph{variational set configuration} function
\ensuremath{\osetSem \vset: \vsetSet \totype \confSet \totype \psetSet}, defined in \figref{vset}.
The configuration function evaluates the presence condition $\dimMeta_i$ of each 
element $\elem_i$ of the variational set with the configuration \config. 
If the evaluation results in \t\ it includes $\elem_i$ in the plain set and otherwise it
does not. \exref{vset-conf} illustrates the configuration of a variational set for all
possible configurations. 
\structure{it'd be nice to have the entire ex in the same page.}

\begin{example}
\label{eg:vset-conf}
Assume we have the feature space $\features = \setDef {\A, \B}$ 
and the variational set $\vset_1 = \setDef {\annot [\A] 2, \annot [\B] 3, 4}$.
$\vset_1$ represents four plain sets:
\begin{alignat*}{1}
\osetSem {\vset_1} &=
\begin{cases}
  \setDef{2,3,4}, & \config = \setDef{\A,\B}\\
  \setDef{2,4}, & \config = \setDef{\A}\\
  \setDef{3,4}, & \config = \setDef{\B}\\
  \setDef{4}, & \config = \setDef { }
\end{cases}
\end{alignat*}
This states that, for example, configuring $\vset_1$ for the variant that enables 
bot \A\ and \B\ (that is, \ensuremath{\A = \t, \B = \t}) results in the plain set
\ensuremath{ \osetSem [\setDef {\A, \B}] {\vset_1} = \setDef {2,3,4} }.
\end{example}

%
%\noindent
Following database notational conventions
we drop the brackets of a variational set when used in database
schema definitions and queries.

%\point{annotated vset.}
A variational set itself can also be annotated with a feature expression.
%
%An \emph{annotated variational set} 
$\annot \vset = \setDef {\annot [\dimMeta_1] {\elem_1},\ldots,\annot [\dimMeta_n] {\elem_n}}^\dimMeta$ is an
\emph{annotated variational set}, 
that is, $\annot \vset \in \annotvsetSet$.
% that it is annotated itself by a \emph{feature expression} \dimMeta.
%We denote an annotated variational set of elements $\elem \in \mathbf{\elemSet}$ with
%\annot \elemSet.
Annotating a variational set with the feature expression \dimMeta\ means that all
elements in the variational set are only present when \dimMeta\ evaluates to \t.
The \emph{normalization} operation $\pushIn {\annot \vset}$ applies this
restriction by pushing it into the presence conditions of the individual
elements:
\ensuremath{
\pushIn {\annot \vset}
= 
\setDef{\annot [\dimMeta_i \wedge \dimMeta] {\elem_i} \myOR 
\annot [\dimMeta_i] \elem_i \in \annot \vset, \sat {\dimMeta_i \wedge \dimMeta}
}}.
%\eric{added that both v-set and annot v-set are of the same type.}
%Thus, we consider both variational sets and annotated variational sets to 
%belong to the set of variational set \vsetSet, that is, we consider them to have the same type. 
Note that both the normalization operation and variational set configuration
are overloaded, that is, they are defined for both variational sets and 
annotated variational sets. 
Also, note that the \emph{normalization} operation also removes elements
with unsatisfiable presence conditions and may also be applied
to an unannotated variational set \vset\ since $\annot[\t]{\vset} = \vset$.
%\ensuremath{
%\vset = \setDef {\annot [\dimMeta_1] \elem_1, \ldots, \annot [\dimMeta_n] \elem_n}}, 
%which is equivalent to the annotated v-set \annot [\t] \vset. Thus,
%\ensuremath{
%\pushIn \vset = \setDef {
%\annot [\dimMeta_i] \elem_i \myOR \annot [\dimMeta_i] \elem_i, \sat {\dimMeta_i}
%}
%}.}
%This restriction
%can be captured by the property:
%$\setDef {\annot [\dimMeta_1] {\elem_1} ,\ldots, \annot [\dimMeta_n] {\elem_n}}^\dimMeta
%\equiv 
%\setDef {\annot [\dimMeta_1 \wedge \dimMeta] {\elem_1},\ldots, \annot [\dimMeta_n \wedge \dimMeta] {\elem_n}}
%$.
%
For example, the annotated variational set
$\vset_1 = \{\annot [\A] 2, \annot [\neg \B] 3, 4, \annot [\C] 5\}^{\A \wedge \B}$
indicates that all the elements of the set can only exist
when both $\A$ and $\B$ are enabled. Thus, normalizing the variational set $\vset_1$
%the set's feature expression
results in
$\{\annot [\A \wedge \B] 2,\annot [\A \wedge \B] 4,\annot [\A \wedge \B \wedge \C] 5\}$. The element $3$ is dropped 
%from the set 
since 
\ensuremath{\neg \sat {\getPCfrom 3 {\vset_1} }},
where
\ensuremath{
{\getPCfrom 3 {\vset_1} } = \neg \B \wedge (\A \wedge \B)}.
%its presence condition is unsatisfiable, i.e., $\neg \sat {\neg \fName_2 \wedge (\fName_1 \wedge \fName_2)}$.
%%
Note that we use the function \getPCfrom \elem {\annot \vset} to 
return the presence condition of a unique variational element within a bigger
variational structure. 
Note that,
without loss of generality, we assume that elements in a variational set
are unique since we can simply disjoin the presence conditions of a repeated 
element, that is, 
\ensuremath{\setDef {\annot [\dimMeta] \elem, \annot [\dimMeta] \elem, \annot [\dimMeta_1] \elem_1, \ldots, \annot [\dimMeta_n] \elem_n} = \setDef {\annot [\dimMeta \vee \VVal \dimMeta] \elem, \annot [\dimMeta_1] \elem_1, \ldots, \annot [\dimMeta_n] \elem_n}}.
% by just referring to the element itself without its
%annotation, i.e., \elem.

In \figref{vset}, we also define several operations, such as union and
intersection, over variational sets; these operations are used in \secref{type-sys}. The
semantics of a variational set operation is equivalent to applying the corresponding
plain set operation to every corresponding variant of the argument variational sets. For
example, the union of two variational sets $\vset_1\cup\vset_2$ should produce a new
variational set $\vset_3$ such that
%
$\forall c\in\confSet.\;
\osetSem{\vset_3} = \osetSem{\vset_1}\,\underline{\cup}\,\osetSem{\vset_2}$,
where $\underline{\cup}$ is the plain set union operation.
%
 This property must hold for all operations over variational sets, that is, for all possible operations, \vsetOp, defined on variational sets the property 
 \ensuremath{
 \Pone: 
 \forall \config \in \confSet. \osetSem {\pushIn {\vset_1} \vsetOp \pushIn {\vset_2}} 
 = \osetSem {\vset_1} \psetOp \osetSem {\vset_2}
 } must hold, where \psetOp\ is the counterpart operation on plain sets.%
\footnote{This property is proved for the operations we define over variational sets in Coq proof assistant~\cite{Khan21}.}

