\subsubsection{Variation-Preserving Property with respect to. Schema}
\label{sec:var-pres}


%\arashComment{ The property of variation preservation is too short and it is not clear why it is important. I also did not find the proofs in Appendix D.}
%\resp{I established why such a property is important in the variational context where we are putting all variants together throughout the paper. here we just define the property and say that it holds at the type level. We also decided to just introduced this as a property for VLDB submission. We'll have the proofs and other properties in another paper.}
%\responded
Similar to other applications of variational research~\cite{CEW16ecoop,CEW14toplas},
the type system must preserve
 the variation encoded in a v-query.
%
We define the 
\emph{variation-preserving property with respect to v-schema}: 
if a query \vQ\ has type \vType\ then 
configuring the type of a valid explicitly annotated query
is the same as the type of its configured
corresponding query. 
%
\thmref{var-pres} defines this property formally.

%, 
%i.e., no matter which path the constrained query takes in the diagram it will results
%to the same set of attributes.
%
% the code that produces the diagram
\begin{wrapfigure}{r}{0.2\textwidth}
\begin{center}
\begin{tikzcd}[column sep=2.3em]
  \constrain \vQ   \rar{\mathit{type}}  \dar[swap,dashed]{\eeSem . }
& {\annot \vType}  \dar[dashed]{\olSem . } \\
  \pQ \rar{\underline{type}}
& \pAttList
\end{tikzcd}
\end{center}
\end{wrapfigure}
%
In the diagram, 
the vertical arrows indicate corresponding configure functions,
\ensuremath{\mathit{type}} indicates VRA's type system, 
i.e., \ensuremath{\mathit{type}(\vQ) = \annot \vAttList} is 
\ensuremath{\envWithoutVctx \vQ {\envInContext [\VVal \vctx] \vType}},
% of v-query \vQ\
%generated by VRA's type system and 
and
\ensuremath{\underline{\mathit{type}}} indicates RA's type system,
i.e., \ensuremath{\pEnv {\pQ} {\pAttList}}.
Note that for simplicity, we assume that corresponding v-schema and schema is
passed to type systems.
% of relational query \pQ.
Simply put, 
the relational type of the configured v-query \vQ\ with configuration \config, 
i.e., \ensuremath{\olSem {\mathit{type} (q)}},
must be the same as the configured variational type 
of the v-query \vQ\ with configuration \config, 
i.e., \ensuremath{\underline {\mathit{type}} (\eeSem {\vQ})}.
\emph{Clearly the diagram commutes}: taking either path of 1) configuring \vQ\ first and 
then getting the relational type of it or 
2) getting the variational type of \vQ\ first and then configuring it results
in the same set of attributes. 
The variation-preserving property enforces the maintenance of variants that a tuple
belongs to through running a query, satisfying second part of \textbf{N2}.
%configuring a v-query \vQ\ for configuration \config\ first and then 
%if we configure v-query \vQ\ for a given configuration \config\ its type (a set of attributes)
%must be the same as if we generate the variational attribute set for
%\vQ\ by VRA's type system and then configure it with \config,
%
%\appref{type-sys-prop-proof} sketches the proof of 
%VRA's type system being variation-preserving.
Variation-preserving property of VRA's type system and RA's type safety~\cite{RAtypeSys} 
implies that VRA's type system is also type safe.
\exref{var-pres} illustrates why the query must be explicitly annotated with the v-schema
in the variation-preserving diagram.

\begin{theorem}
\label{thm:var-pres}
For all configurations \config, if a query \vQ\ has type \vType\ 
then its configured query \ensuremath{\eeSem {\constrain \vQ}}
has type \ensuremath{\olSem {\vType}}, i.e., \\
\centerline{
\ensuremath{
\forall \config \in \confSet. \envWithoutVctx { \vQ} {\vType} \Rightarrow 
\pEnv [\osSem {\vSch}] {\eeSem {\constrain \vQ}} {\olSem {\vType}}
}}.
\end{theorem}

%\begin{proof}
%We proved this theorem in the Coq proof assistant.
%\TODO{It can be find here.}
%\TODO{Eric, maybe we have a sketch of it if we have space?}
%\end{proof}

\begin{example}
\label{eg:var-pres}
Consider the v-query 
\ensuremath{\vQ_5 = \vPrj [{\vAtt_1, \optAtt [\fOne \wedge \fTwo] [\vAtt_2], \optAtt [\fTwo] [\vAtt_3]}] \vRel} 
given in \exref{conf-vq}. It is well-typed
and  it has the type
\ensuremath{\vAttList =
\setDef {\optAtt [\fOne] [\vAtt_1], 
\optAtt [\fOne \wedge \fTwo] [\vAtt_2], 
\optAtt [\fTwo] [\vAtt_3]}
}.
Configuring \vAttList\ for the variant that both \fOne\ and \fTwo\ are disabled
results in an empty attribute set. However, the type of its configured query
for this variant, i.e., \ensuremath{\eeSem [\setDef \ ] {\vQ_5} =  \pi_{\pAtt_1} \pRel}, is the 
attribute set \ensuremath{\setDef {\pAtt_1}}. This violates the
variation-preserving property. A similar problem happens for the variant of
\setDef {\fTwo}, i.e., \ensuremath{
\underline{\mathit{type}} \left( \eeSem [\setDef \fTwo] {\vQ_5} \right) = 
\underline{\mathit{type}} \left( \pi_{\pAtt_1, \pAtt_3} \pRel \right) = 
\setDef{\pAtt_1, \pAtt_3} \not = \setDef{\pAtt_3} 
= \olSem [\setDef \fTwo] {\vAttList}
= \olSem [\setDef \fTwo] {\mathit{type} \left( \vQ_5 \right)}
}. However, the variation-preserving property holds for the 
explicitly annotated query with the v-schema, i.e., 
\ensuremath{
\constrain [\vSch_3] {\vQ_5} = 
\vPrj [{\optAtt [\fOne] [\vAtt_1], \optAtt [\fOne \wedge \fTwo] [\vAtt_2], \optAtt [\fTwo] [\vAtt_3]}] \vRel
}.
%We can restrict VRA's type system to enforce users to incorporate the
%v-schema into their queries, e.g., \ensuremath{\vQ_5} becomes
%\ensuremath{\VVal \vQ_5 = 
%\vPrj [{\optAtt [\fOne] [\vAtt_1], 
%\optAtt [\fOne \wedge \fTwo] [\vAtt_2], 
%\optAtt [\fTwo] [\vAtt_3]}] \vRel
%}. However, one of the purposes of our type system is to relieve the users 
%from having to encode the VDB's variability into their queries.
%% this burdens the user to know the exact variation encoded in
%%the database in addition to the original variation they want to encode in their query.
%To avoid this violation without requiring users to repeat VDB's variability in their queries,
%after type checking a query we push the v-schema onto the v-query,
%e.g., doing so for \ensuremath{\vQ_5} results in \ensuremath{\VVal \vQ_5}.
\end{example}